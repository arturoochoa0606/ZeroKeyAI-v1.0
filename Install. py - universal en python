import os
import sys
import subprocess
import platform
import json
import time

BANNER = """
============================================
       INSTALADOR UNIVERSAL ZeroKeyAI
                 Version 1.0
============================================
"""

def run(cmd, shell=False):
    """Ejecuta comandos de forma segura."""
    try:
        print(f"‚Üí Ejecutando: {cmd}")
        result = subprocess.run(cmd, shell=shell, check=True)
        return result.returncode == 0
    except subprocess.CalledProcessError:
        return False


def check_python():
    print("üîç Verificando versi√≥n de Python...")
    if sys.version_info < (3, 10):
        print("‚ùå Python 3.10+ es requerido.")
        sys.exit(1)
    print(f"‚úî Python detectado: {platform.python_version()}")


def check_pip():
    print("üîç Buscando pip...")
    if run(["pip", "--version"]):
        print("‚úî pip detectado")
        return True
    if run(["pip3", "--version"]):
        print("‚úî pip3 detectado")
        return True
    print("‚ùå No se encontr√≥ pip.")
    sys.exit(1)


def check_conda():
    print("üîç Buscando Conda...")
    if run(["conda", "--version"]):
        print("‚úî Conda detectado")
        return True
    print("‚Ñπ Conda no encontrado, se usar√° pip.")
    return False


def create_directories():
    dirs = ["logs", "data", "temp"]
    print("üìÅ Creando carpetas necesarias...")
    for d in dirs:
        os.makedirs(d, exist_ok=True)
    print("‚úî Carpetas listas")


def install_with_pip():
    print("üì¶ Instalando dependencias con pip...")
    if not os.path.exists("requirements.txt"):
        print("‚ö† requirements.txt no existe. Saltando...")
        return

    run(["pip", "install", "-r", "requirements.txt"])
    print("‚úî Dependencias instaladas con pip")


def install_with_conda():
    print("üì¶ Instalando dependencias con conda...")
    if not os.path.exists("environment.yml"):
        print("‚ö† environment.yml no existe. Saltando...")
        return

    run(["conda", "env", "update", "--file", "environment.yml", "--name", "zerokeyai"])
    print("‚úî Dependencias instaladas con conda")


def main():
    os.system("cls" if os.name == "nt" else "clear")
    print(BANNER)

    check_python()
    check_pip()
    has_conda = check_conda()
    create_directories()

    print("\n=== M√©todo de instalaci√≥n ===")
    if has_conda:
        print("1) Instalar usando Conda")
        print("2) Instalar usando pip")
        choice = input("Selecciona opci√≥n (1/2): ").strip()
    else:
        choice = "2"

    if choice == "1":
        install_with_conda()
    else:
        install_with_pip()

    print("\n======================================")
    print("   ‚úî ZeroKeyAI instalado correctamente")
    print("======================================")
    print("Puedes ejecutar el proyecto con:\n")
    print("   python -m zerokey.main\n")

    input("Presiona ENTER para salir...")


if __name__ == "__main__":
    main()
